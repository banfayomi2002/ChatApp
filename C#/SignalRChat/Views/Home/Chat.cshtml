@{
    ViewBag.Title = "Chat";
}

<div class="container">
    <h3 class="title">CHAT ROOM  </h3>
    <div class="row">
        <div class="column left">
            <label class="chat" id="chat">Group List</label>
        </div>
        <div class="column right">
            <ul id="discussion" contenteditable:"false"></ul>
        </div>
    </div>
    <div class="row">
        <textarea id="message" style="width: 654px;"></textarea>
        <input type="button" style="padding:10px" id="sendmessage" value="Send" />
    </div>
        <input type="hidden" id="displayname" />

    </div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        var check = 0;
        var flag = true;
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + htmlEncode(name)
                    + '</strong>: ' + htmlEncode(message) + '</li>');
              //Update the list of users
                if (check == 1) {
                    $('#chat').empty();
                    $("#chat").append("Group List");
                    chat.server.getAllActiveConnections().done(function (connections) {
                        $.map(connections, function (item) {
                              
                            $("#chat").append("<li>" + item + "</li>");

                        });
                    }); 
                }                         
            };

            // Get the user name and store it to prepend to messages.

             $('#displayname').val(prompt('Enter your name:', ''));           
          
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
            // Get the user name to keep track of users
                chat.server.connect($('#displayname').val());
                check = 1;
            //Returns the list of users
                chat.server.getAllActiveConnections().done(function (connections) {
                    $.map(connections, function (item) {

                        $("#chat").append("<li>" + item + "</li>");
                        });                    
                });

                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                   
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });                               
            });
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

    </script>
}